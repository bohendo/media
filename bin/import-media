#!/bin/bash
set -e

good="✅"
warn="⚠️ "
fail="❌"

####################
## assert & setup env

if [[ -z "$(command -v exiftool)" ]]
then echo "$fail Install exiftool first" && exit 1
fi

if [[ -z "$(command -v ffmpeg)" ]]
then echo "$fail Install ffmpeg first" && exit 1
fi

media=${MEDIA_DIR:-$HOME/Media}
mkdir -p "$media"

tmp="/tmp/media"
mkdir -p "$tmp"

####################
## parse args

target="$1"
if [[ ! -f "$target" ]]
then echo "$fail File does not exist at $target" && exit 1
fi

categories=(camera screenshots private)
category="$2"
if [[ -z "$category" ]]
then
  echo "Use the 2nd arg to specify the category of the imported media"
  echo "Valid categories: ${categories[*]}"
  exit 1;
elif ! grep -w -q "$category" <<<"${categories[*]}"
then
  echo "Category $category is invalid"
  echo "Valid categories: ${categories[*]}"
  exit 1;
fi

if [[ "$3" == "-y" || "$3" == "--yes" ]]
then dryrun="false"
elif [[ "$3" == "-n" || "$3" == "--no" ]]
then dryrun="true"
else
  echo "Use the 3rd arg to specify whether or not you actually want to make changes"
  echo "  -n  No I don't want to make changes, show me what the changes would be"
  echo "  -y  Yes I want to make changes"
  exit 1;
fi

if [[ "$4" == "--rm" || "$4" == "--remove" ]]
then remove="true"
else remove="false"
fi

####################
## Ensure target is valid & not a duplicate

target_hash=$(sha256sum "$target" | cut -d " " -f 1)

index=$media/.index
if [[ ! -f "$index" ]]
then touch "$index"
fi

entry=$(grep "$target_hash" "$index" || true)
if [[ -n "$entry" && "$entry" == *:* ]]
then echo "$good File has already been imported & is available at ${entry#*:}" && exit 0
fi

dotype=${target##*.}
ext=$(exiftool -FileTypeExtension "$target" 2> /dev/null | sed 's/^.*: //')

if [[ \
  "$ext" != "3gp" &&\
  "$ext" != "avi" &&\
  "$ext" != "gif" &&\
  "$ext" != "heic" &&\
  "$ext" != "jpg" &&\
  "$ext" != "m4v" &&\
  "$ext" != "mov" &&\
  "$ext" != "mp4" &&\
  "$ext" != "png" \
  ]]
then echo "$fail Skipping file with unsupported FileTypeExtension $ext: $target" && exit 1
fi

exiftool "$target" > /dev/null
res=$?
if [[ "$res" != "0" ]]
then echo "Invalid exif data for $target" && exit 1
fi

####################
## set create date

tmp_target="$tmp/$(basename "$target")"
rm -rf "$tmp_target"
cp "$target" "$tmp_target"
chmod 644 "$tmp_target"

function getCreateDate {
  exiftool -CreateDate "$1" 2> /dev/null \
    | sed 's/.*  ://' \
    | sed 's/: /:0/g' \
    | sed 's/://g' \
    | sed 's/\+.*//g' \
    | sed 's/ /-/g' \
    | sed 's/-$//' \
    | sed 's/^-//'
}

function setCreateDate {
  t="$1"
  d="$2"
  exiftool -ignoreMinorErrors -CreateDate="${d::4}:${d:4:2}:${d:6:2} ${d:9:2}:${d:11:2}:${d:13:2}" "$t" > /dev/null
  created=$(getCreateDate "$t")
  original="${t}_original"
  if [[ "$original" != "$tmp/$(basename "${t}_original")" ]]
  then mv -f "$original" "$tmp/$(basename "${t}_original")"
  fi
  echo "Updated exif data for $t w new create date: ${created}"
}

created=$(getCreateDate "$target")
if [[ -z "$created" ]]
then

  if [[ "$target" =~ (IMG|DOC|VID)-[[:digit:]]{8}-WA[[:digit:]]{4,}.* ]]
  then
    setCreateDate "$tmp_target" "$(echo "$target" | cut -d "-" -f 2)-000000"
    created=$(getCreateDate "$tmp_target")

  # eg 2019-10-26 10.36.10.jpg
  elif [[ "$target" =~ [[:digit:]]{4}-[[:digit:]]{2}-[[:digit:]]{2}\ [[:digit:]]{2}\.[[:digit:]]{2}\.[[:digit:]]{2}.* ]]
  then
    setCreateDate "$tmp_target" "$(basename "$target" | sed 's/-//g' | sed 's/ /-/g' | sed 's/\.//' | sed 's/\.//' | sed 's/\..*//')"
    created=$(getCreateDate "$tmp_target")

  # eg SmartSelect_20200613-210904_Prime Video.jpg
  elif [[ "$target" =~ _[[:digit:]]{8}-[[:digit:]]{6}_*.* ]]
  then
    setCreateDate "$tmp_target" "$(basename "$target" | cut -d "_" -f 2)"
    created=$(getCreateDate "$tmp_target")

  # eg Screenshot from 2020-08-26 14-03-02.png
  elif [[ "$target" =~ \ [[:digit:]]{4}-[[:digit:]]{2}-[[:digit:]]{2}\ [[:digit:]]{2}-[[:digit:]]{2}-[[:digit:]]{2}.* ]]
  then
    setCreateDate "$tmp_target" "$(basename "$target" | cut -d " " -f 3-4 | sed 's/\..*//' | sed 's/-//g' | sed 's/ /-/')"
    created=$(getCreateDate "$tmp_target")

  else
    setCreateDate "$tmp_target" "00000000-000000"
    created="00000000-000000" # TODO: check to see if the filename includes a date?
  fi

fi

########################################
## Conversions: heic=>jpg, avi,m4v,mov=>mp4

# Convert heic files into jpg
if [[ "$ext" == "heic" ]]
then
  if [[ -z "$(command -v heif-convert)" ]]
  then echo "$fail Install heif-convert first" && exit 1
  fi
  new_target="$tmp/$(basename "$target" | sed 's/\.'"$dotype"'/\.jpg/')"
  if [[ -f "$new_target" ]]
  then rm -f "$new_target"
  fi
  echo "Converting heic-formatted $target into an jpg at $new_target"
  heif-convert -q95 "$target" "$new_target" > /dev/null
  setCreateDate "$new_target" "$created"
  tmp_target="$new_target"
  ext="jpg"
fi

# Convert video files into mp4
# Do we need to rm data streams? https://github.com/aminyazdanpanah/PHP-FFmpeg-video-streaming/issues/74
if [[ "$ext" == "3gp" || "$ext" == "avi" || "$ext" == "m4a" || "$ext" == "mov" ]]
then
  new_target="$tmp/$(basename "$target" | sed 's/\.'"$dotype"'/\.mp4/')"
  if [[ -f "$new_target" ]]
  then rm -f "$new_target"
  fi
  echo "Converting $ext-formatted $target into an mp4 at $new_target"
  ffmpeg -i "$target" -loglevel error -crf 18 -f mp4 "$new_target"
  setCreateDate "$new_target" "$created"
  tmp_target="$new_target"
  ext="mp4"
fi

########################################
## Import

new_hash=$(sha256sum "$tmp_target" | cut -d " " -f 1)
suffix=$(echo "$new_hash" | head -c 8)

name="$created-$suffix.$ext"
subpath="$category/$name"
path="$media/$subpath"
if [[ ! -d "$(dirname "$path")" ]]
then mkdir -p "$(dirname "$path")"
fi

# If this file already exists, check to make sure it's valid & maybe delete the input file
if [[ -f "$path" ]]
then
  dup_digest=$(sha256sum "$path" | cut -d " " -f 1)
  dup_suffix=$(echo "$dup_digest" | head -c 8)
  if [[ "$path" =~ .*-$dup_suffix\..* ]]
  then echo "$good Valid file already exists at $path"
  else echo "$fail Invalid file exists at $path (expected suffix of $dup_suffix)" && exit 1
  fi
  if [[ "$dryrun" == "false" && "$remove" == "true" ]]
  then rm -f "$target" && echo "$warn Removed $target"
  fi
  exit
fi

# Check for other files in media w the same hash
if ! dups=$(find "$media/" -type "f" -name "*-$suffix.*")
then echo "$fail Failed to search for files with hash of $suffix" && exit 1
fi
if [[ -n "$dups" ]]
then
  for dup in $dups
  do
    dup_digest=$(sha256sum "$dup" | cut -d " " -f 1)
    if [[ "$dup_digest" == "$target_hash" ]]
    then echo "$good $dup & target have same hash: $dup_digest"
    else echo "$warn $dups ($dup_digest) & target ($target_hash) have similar digests"
    fi
  done
  exit 1
fi

if [[ "$dryrun" == "true" ]]
then echo "$good Import $target to $subpath"
elif [[ "$dryrun" == "false" ]]
then
  cp -i "$tmp_target" "$path"
  echo "$good Imported $target to $subpath"
  echo "$target_hash:$subpath" >> "$index"

  if [[ "$remove" == "true" ]]
  then
    dup_suffix=$(sha256sum "$path" | cut -d " " -f 1 | head -c 8)
    if [[ "$path" =~ .*-$dup_suffix\..* ]]
    then rm -f "$target" && echo "$warn Removed $target"
    else echo "$fail Invalid file exists at $path (expected suffix of $dup_suffix)" && exit 1
    fi
  fi
fi
